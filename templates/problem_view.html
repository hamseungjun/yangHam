{% extends "base.html" %}

{% block content %}
<aside class="theory-sidebar">
    <h3>
         í•µì‹¬ ì´ë¡ 
        <button id="theory-toggle-btn" class="theory-toggle">â–¼</button>
    </h3>
    <div id="theory-content" class="theory-content">
        {{ current_problem.theory | safe }}
    </div>

    <hr class="sidebar-divider">
    <div class="tutor-chatbot">
        <h4>ğŸ¤– AI ì¡°êµ ìŒ¤ê»˜ ì§ˆë¬¸í•˜ê¸°</h4>
        <form id="tutor-form" action="/ask-tutor/{{ current_chapter_slug }}/{{ current_problem.problem_number_in_chapter }}" method="post">
            <textarea name="question" rows="3" placeholder="íŒŒì´ì¬ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!"></textarea>
            <button type="submit" class="tutor-button">ì§ˆë¬¸í•˜ê¸°</button>
        </form>

        {% if tutor_question and tutor_answer %}
        <div class="tutor-response" id="tutor-response-box">
            <div class="tutor-q"><strong>ë‚˜ì˜ ì§ˆë¬¸:</strong> {{ tutor_question }}</div>
            <div class="tutor-a"><strong>ì¡°êµ ìŒ¤ ë‹µë³€:</strong><br>{{ tutor_answer | replace('\n', '<br>') | safe }}</div>
        </div>
        {% endif %}
    </div>
</aside>

<main class="problem-area">
    <div class="progress-container">
        {% for i in range(1, total_problems + 1) %}
        <a href="/{{ current_chapter_slug }}/{{ i }}" class="progress-step-link">
            <div class="progress-step" data-step-id="{{ (current_chapter.problems | selectattr('problem_number_in_chapter', 'equalto', i) | list | first).id }}">
                <div class="progress-step-circle">{{ i }}</div>
                {% if not loop.last %}
                <div class="progress-step-line"></div>
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>

    <div class="problem-header">
        <h2>{{ current_problem.title }}</h2>
    </div>
    <p class="question">{{ current_problem.question }}</p>

    <div class="editor-container">
        <textarea id="code-editor">{% if user_code %}{{ user_code }}{% else %}# ì—¬ê¸°ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.{% endif %}</textarea>
    </div>
    
    <div id="interactive-area">
        <div class="button-area">
            <form id="check-form" action="/check-answer/{{ current_chapter_slug }}/{{ current_problem.problem_number_in_chapter }}" method="post">
                <input type="hidden" name="user_code" id="check-user-code">
                <button type="submit">ì •ë‹µ í™•ì¸í•˜ê¸°</button>
            </form>
        </div>
        
        {% if feedback %}
        <div class="result-box {{ 'feedback-correct' if is_correct else 'feedback-incorrect' }}">
            <h4>âœ”ï¸ ì •ë‹µ í™•ì¸</h4>
            <p>{{ feedback.strip() | replace('\n', '<br>') | safe }}</p>
        </div>
        {% endif %}
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const editorEl = document.getElementById("code-editor");
        if (!editorEl) return;

        const editor = CodeMirror.fromTextArea(editorEl, {
            lineNumbers: true, mode: "python", theme: "default", indentUnit: 4
        });

        document.getElementById("check-form").addEventListener("submit", () => {
            document.getElementById("check-user-code").value = editor.getValue();
        });
        
        const completedProblems = new Set({{ completed_problems | tojson }});
        const currentProblemId = {{ current_problem.id }};

        function updateProgressBar() {
            document.querySelectorAll('.progress-step').forEach(stepEl => {
                const problemDBId = parseInt(stepEl.dataset.stepId);
                stepEl.classList.remove('active', 'completed');
                const circle = stepEl.querySelector('.progress-step-circle');
                
                if (completedProblems.has(problemDBId)) {
                    stepEl.classList.add('completed');
                    circle.innerHTML = 'âœ”';
                } else {
                    circle.innerHTML = parseInt(stepEl.parentElement.href.split('/').pop());
                }
                
                if (problemDBId === currentProblemId) {
                    stepEl.classList.add('active');
                }
            });
        }
        updateProgressBar();

        const toggleBtn = document.getElementById('theory-toggle-btn');
        const theoryContent = document.getElementById('theory-content');
        if (toggleBtn && theoryContent) {
            toggleBtn.addEventListener('click', () => {
                theoryContent.classList.toggle('open');
                toggleBtn.textContent = theoryContent.classList.contains('open') ? 'â–²' : 'â–¼';
            });
        }
        
        const resultBox = document.querySelector('.result-box');
        if (resultBox) {
            resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // templates/problem_view.html ì˜ <script> íƒœê·¸ ì•ˆ
        const tutorResponseBox = document.getElementById('tutor-response-box');
        if (tutorResponseBox) {
            tutorResponseBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
</script>
{% endblock %}