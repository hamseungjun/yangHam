{% extends "base.html" %}

{% block content %}
<main class="mypage-main">
    <div class="mypage-header">
        <h2>{{ user.username }}님의 학습 현황</h2>
        <div class="rank-display">
            <strong>현재 등급:</strong> {{ rank_info.name }}
            <img src="{{ url_for('static', path='images/' + rank_info.image) }}" alt="{{ rank_info.name }}" class="rank-icon-large">
        </div>
    </div>

    <div class="chapter-grid">
        {% for chapter in all_chapters %}
            {% if chapter.problems %}
                {% set total = chapter.problems | length %}
                {% set completed_count = namespace(value=0) %}
                {% for p in chapter.problems %}
                    {% if p.id in completed_problems_ids %}
                        {% set completed_count.value = completed_count.value + 1 %}
                    {% endif %}
                {% endfor %}

                <div class="chapter-card" data-total="{{ total }}" data-completed="{{ completed_count.value }}">
                    <div class="progress-ring">
                        <svg class="progress-ring__svg" width="120" height="120">
                           <circle class="progress-ring__track" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                           <circle class="progress-ring__indicator" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                        </svg>
                        <div class="progress-ring__text">
                            <span class="progress-ring__number">{{ completed_count.value }}</span>
                            <span class="progress-ring__total">/ {{ total }}</span>
                        </div>
                    </div>
                    <h3>{{ chapter.title }}</h3>
                    <a href="/{{ chapter.slug }}/1" class="start-learning-btn">학습 시작</a>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.chapter-card').forEach(card => {
        const indicator = card.querySelector('.progress-ring__indicator');
        if (!indicator) return;

        const radius = indicator.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        
        const total = parseInt(card.dataset.total);
        const completed = parseInt(card.dataset.completed);
        const percent = total > 0 ? (completed / total) : 0;
        
        const offset = circumference - percent * circumference;

        indicator.style.strokeDasharray = `${circumference} ${circumference}`;
        setTimeout(() => {
            indicator.style.strokeDashoffset = offset;
        }, 100);
    });
});
</script>
{% endblock %}